#!/bin/sh

# This script is used to control wifi state and connections with dmenu

set -euo pipefail

select_wifi () {
	ssid=$(nmcli device wifi list \
			| sed -n '1!p' \
			| cut -b 28- \
			| sed 's/ \{2,\}/	/g' \
			| awk -F'	' '{print $6"  "$1}' \
			| expand -t 4 \
			| dmenu -p "Select Wifi  :" -l 20 \
			| sed 's/ \+/ /g' \
			| cut -d' ' -f 2-)
	# echo $ssid

	[ -z "${ssid}" ] && exit 0

	[ "${ssid}" == "$(active_ssid)" ] && exit 0

	echo "$(previously_connected)" | grep "${ssid}$" \
		&& nmcli connection up ${ssid} \
		&& sleep 5 \
		&& wifi_status \
		&& exit 0

	pass=$(echo "" | dmenu -P -p "Enter Password  :")
	# echo $pass

	nmcli device wifi connect "${ssid}" password "${pass}"
	# Wait for 10 seconds and display status
	sleep 10
	wifi_status
}

wifi_status () {
	# This prints out the password with the status message
	# status_msg="$(nmcli device wifi show)" \
	#	|| status_msg="Wifi is turned off"

	# This hides the password
	status_msg="$(nmcli device wifi show | sed -n '3!p')" \
		|| status_msg="Wifi is turned off"

	notify-send "Wifi Status" "${status_msg}"
}

previously_connected () {
	echo "$(nmcli connection show \
				| sed -n '1,2!p' \
				| sed 's/ \{2,\}/	/g' \
				| cut -f 1)"
}

active_ssid () {
	echo "$(nmcli connection show --active \
				| sed -n '1!p' \
				| sed 's/ \{2,\}/	/g' \
				| cut -f 1)"
}

turn_on_prompt="Turn on"
turn_off_prompt="Turn off"
select_prompt="Select"
status_prompt="Print status"
show_password_prompt="Show password"

wifi_on=$(nmcli radio wifi)

[ ${wifi_on} == "enabled" ] \
&&	all_prompts="\
${turn_off_prompt}
${select_prompt}
${status_prompt}
${show_password_prompt}" \
||	all_prompts="\
${turn_on_prompt}
${select_prompt}"

choice=$(echo -e "${all_prompts}" | dmenu -l 20 -p "  Options:")

case "$choice" in
	"${turn_on_prompt}")
		nmcli radio wifi on
		;;
	"${turn_off_prompt}")
		nmcli radio wifi off
		;;
	"${select_prompt}")
		select_wifi
		;;
	"${status_prompt}")
		wifi_status
		;;
	"${show_password_prompt}")
		[ -z "$(which alacritty)" ] \
		&& notify-send "Wifi Status" "$(nmcli device wifi show-password)" \
		|| alacritty --class FloatingWindow --hold -e nmcli device wifi show-password
		;;
	*)
		exit 0
		;;
esac
